<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Davos Heavy Industries Mission Log</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #0a0a0a;
            color: #00ff41;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
        }
        
        @media screen and (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding-right: 0;
                margin-bottom: 20px;
            }
        }
        
        .sidebar {
            width: 300px;
            padding-right: 20px;
        }
        
        .main-content {
            flex: 1;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border: 1px solid #004400;
        }
        
        h1, h2, h3 {
            color: #00ff41;
        }
        
        button {
            background-color: #001100;
            color: #00ff41;
            border: 1px solid #00ff41;
            padding: 5px 10px;
            margin: 5px 0;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }
        
        button.delete {
            border-color: #ff0055;
            color: #ff0055;
        }
        
        .login-form, .admin-tools, .log-form {
            background-color: #001100;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #004400;
        }
        
        input, textarea, select {
            background-color: #0a0a0a;
            color: #00ff41;
            border: 1px solid #004400;
            padding: 5px;
            width: 100%;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }
        
        textarea {
            height: 150px;
        }
        
        .log-entry {
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #004400;
            cursor: pointer;
        }
        
        .log-entry:hover {
            background-color: #001100;
        }
        
        .log-entry.selected {
            background-color: #002200;
        }
        
        .log-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            margin-bottom: 5px;
        }
        
        .log-preview {
            font-size: 0.8em;
            opacity: 0.7;
        }
        
        .private-log {
            color: #ff0055;
        }
        
        .public-log {
            color: #00ccff;
        }
        
        img {
            max-width: 100%;
            margin: 10px auto;
            display: block;
        }
        
        .caption {
            font-size: 0.8em;
            text-align: center;
            margin-bottom: 15px;
        }
        
        /* Personnel styles */
        .personnel-section {
            margin: 15px 0;
            padding: 10px;
            background-color: rgba(0, 17, 0, 0.5);
            border: 1px solid #004400;
        }

        .personnel-title {
            font-size: 0.9em;
            margin-bottom: 10px;
            border-bottom: 1px solid #004400;
            padding-bottom: 5px;
        }

        .personnel-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .personnel-card {
            width: 150px;
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid #004400;
            padding: 5px;
        }

        .personnel-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border: 1px solid #004400;
            float: left;
            margin-right: 8px;
            margin-bottom: 5px;
        }

        .personnel-name {
            font-size: 0.85em;
            font-weight: bold;
            margin-bottom: 3px;
            color: #00ff41;
        }

        .personnel-status {
            font-size: 0.7em;
            margin-bottom: 3px;
        }

        .status-living {
            color: #00ff41;
        }

        .status-deceased {
            color: #ff0055;
        }

        .status-fubar {
            color: #ff5500;
        }

        .status-unknown,
        .status-missing {
            color: #ffff00;
        }

        .personnel-details {
            font-size: 0.7em;
            clear: both;
            max-height: 80px;
            overflow-y: auto;
        }
        
        /* Scrollbar styling */
        .personnel-details::-webkit-scrollbar {
            width: 8px;
        }

        .personnel-details::-webkit-scrollbar-track {
            background: #001100;
            border-radius: 4px;
        }

        .personnel-details::-webkit-scrollbar-thumb {
            background: #004400;
            border-radius: 4px;
        }

        .personnel-details::-webkit-scrollbar-thumb:hover {
            background: #006600;
        }

        /* For Firefox */
        .personnel-details {
            scrollbar-width: thin;
            scrollbar-color: #004400 #001100;
        }
        
        /* Title link hover effect */
        .title-link:hover {
            opacity: 0.8;
            cursor: pointer;
        }

        /* Type toggle styles */
        .type-toggle {
            display: flex;
            margin-bottom: 10px;
            border: 1px solid #004400;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .type-toggle button {
            flex: 1;
            margin: 0;
            border: none;
            padding: 8px;
            font-size: 0.9em;
        }
        
        .type-toggle button.active {
            background-color: #004400;
        }
        
        .type-toggle button:first-child {
            border-right: 1px solid #004400;
        }

        /* CRT screen effect */
        .crt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            overflow: hidden;
        }

        /* Scanline effect */
        .scanline {
            position: absolute;
            width: 100%;
            height: 4px;
            background: rgba(0, 255, 65, 0.15);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
            opacity: 0.75;
            z-index: 101;
            animation: scanline 8s linear infinite;
        }

        /* Screen flicker */
        .flicker {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: rgba(0, 20, 0, 0);
            z-index: 102;
            animation: flicker 0.3s infinite;
            opacity: 0.03;
        }

        /* CRT screen glow */
        .crt-glow {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-shadow: inset 0 0 200px rgba(0, 80, 0, 0.15);
            z-index: 99;
            pointer-events: none;
        }

        /* Subtle scanline texture */
        .scanlines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(0, 255, 65, 0.03) 51%
            );
            background-size: 100% 4px;
            z-index: 98;
            pointer-events: none;
        }

        /* Pattern Lock System */
        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-gap: 10px;
            margin: 20px 0;
        }
        
        .pattern-node {
            width: 100%;
            aspect-ratio: 1;
            background-color: #001100;
            border: 1px solid #004400;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: monospace;
            font-size: 20px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .pattern-node:before {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80%;
            height: 80%;
            transform: translate(-50%, -50%);
            border: 1px dashed #006600;
            opacity: 0.5;
        }
        
        .pattern-node:after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30%;
            height: 30%;
            transform: translate(-50%, -50%);
            background-color: #008800;
            opacity: 0.2;
            border-radius: 50%;
        }
        
        .pattern-node:hover {
            background-color: #002200;
        }
        
        .pattern-node.selected {
            background-color: #004400;
        }
        
        .pattern-node.selected:after {
            opacity: 0.8;
        }
        
        .access-level {
            margin-top: 20px;
            border-top: 1px solid #004400;
            padding-top: 10px;
        }
        
        .access-level button {
            margin-right: 10px;
        }
        
        .access-level button.active {
            background-color: #004400;
        }
        
        .login-instructions {
            font-size: 0.8em;
            margin-bottom: 15px;
            border-bottom: 1px solid #004400;
            padding-bottom: 5px;
        }
        
        .node-symbol {
            color: #00ff41;
            opacity: 0.8;
            font-size: 15px;
            text-shadow: 0 0 5px #00ff41;
        }
        
        .pattern-feedback {
            height: 30px;
            margin-top: 10px;
            color: #ff0055;
            text-align: center;
        }

        /* Animations */
        @keyframes scanline {
            0% {
                top: -5%;
            }
            100% {
                top: 105%;
            }
        }

        @keyframes flicker {
            0% { opacity: 0.03; }
            50% { opacity: 0.02; }
            100% { opacity: 0.03; }
        }
        
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        
        .pulse {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <!-- DAVOS ASCII art title as hyperlink -->
    <a href="index.html" class="title-link" style="text-decoration: none; color: inherit; display: block;">
        <pre style="font-family: monospace; color: #00ff41; text-align: center; margin: 20px 0 0 0; line-height: 1.2; font-size: 16px;">
██████╗  █████╗ ██╗   ██╗ ██████╗ ███████╗
██╔══██╗██╔══██╗██║   ██║██╔═══██╗██╔════╝
██║  ██║███████║██║   ██║██║   ██║███████╗
██║  ██║██╔══██║╚██╗ ██╔╝██║   ██║╚════██║
██████╔╝██║  ██║ ╚████╔╝ ╚██████╔╝███████║
╚═════╝ ╚═╝  ╚═╝  ╚═══╝   ╚═════╝ ╚══════╝
        </pre>
        <h3 style="text-align: center; margin: 5px 0 20px 0; color: #00ff41; font-family: 'Courier New', monospace; font-size: 14px;">HEAVY INDUSTRIES CLASSIFIED MISSION DATA CORE</h3>
    </a>
    
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div id="login-section">
            <div id="login-form" class="login-form">
    <h3>SECURE LOGIN</h3>
    <p>Please select your access level:</p>
    <div style="display: flex; gap: 10px; margin: 20px 0;">
        <button onclick="handleDirectLogin('admin')" style="flex: 1;">ADMIN</button>
        <button onclick="handleDirectLogin('gamemaster')" style="flex: 1;">GAMEMASTER</button>
        <button onclick="handleDirectLogin('player')" style="flex: 1;">PLAYER</button>
    </div>
    <div id="login-error" style="color: #ff0055; display: none;"></div>
</div>
                    
                    <div class="access-level">
                        <span>ACCESS LEVEL:</span>
                        <button id="access-admin" class="active">ADMIN</button>
                        <button id="access-gamemaster">GAMEMASTER</button>
                        <button id="access-player">PLAYER</button>
                    </div>
                    
                    <div class="pattern-grid">
                        <div class="pattern-node" data-index="0"><div class="node-symbol">╔</div></div>
                        <div class="pattern-node" data-index="1"><div class="node-symbol">╦</div></div>
                        <div class="pattern-node" data-index="2"><div class="node-symbol">╗</div></div>
                        <div class="pattern-node" data-index="3"><div class="node-symbol">╠</div></div>
                        <div class="pattern-node" data-index="4"><div class="node-symbol">╬</div></div>
                        <div class="pattern-node" data-index="5"><div class="node-symbol">╣</div></div>
                        <div class="pattern-node" data-index="6"><div class="node-symbol">╚</div></div>
                        <div class="pattern-node" data-index="7"><div class="node-symbol">╩</div></div>
                        <div class="pattern-node" data-index="8"><div class="node-symbol">╝</div></div>
                    </div>
                    
                    <div class="pattern-feedback" id="pattern-feedback"></div>
                    
                    <button id="clear-pattern">CLEAR PATTERN</button>
                    <button id="submit-pattern">VERIFY IDENTITY</button>
                </div>
            </div>
            
            <div id="admin-tools" class="admin-tools" style="display: none;">
                <h3>ADMIN CONTROLS</h3>
                <button id="new-log-btn">NEW MISSION LOG</button>
                <button id="export-btn">EXPORT LOGS</button>
                <button id="import-btn">IMPORT LOGS</button>
                <button id="toggle-crt-btn">TOGGLE CRT EFFECT</button>
                <button id="logout-btn">LOGOUT</button>
                <input type="file" id="import-file" accept=".json" style="display: none;">
            </div>
            
            <div id="new-log-form" class="log-form" style="display: none;">
                <h3>CREATE NEW LOG</h3>
                <label for="new-title">TITLE:</label>
                <input type="text" id="new-title">
                <label for="new-date">DATE:</label>
                <input type="text" id="new-date" placeholder="YYYY.MM.DD">
                <label for="new-preview">PREVIEW:</label>
                <input type="text" id="new-preview">
                <label for="new-type">TYPE:</label>
                <div class="type-toggle">
                    <button type="button" id="new-type-public" class="active">PUBLIC</button>
                    <button type="button" id="new-type-private">CLASSIFIED</button>
                </div>
                <input type="hidden" id="new-type" value="public">
                <label for="new-content">CONTENT:</label>
                <textarea id="new-content"></textarea>
                <div>
                    <input type="checkbox" id="new-has-image" style="width: auto;">
                    <label for="new-has-image">INCLUDE IMAGE</label>
                </div>
                <div id="new-image-section" style="display: none;">
                    <label for="new-image-url">IMAGE URL:</label>
                    <input type="text" id="new-image-url">
                    <label for="new-image-caption">CAPTION:</label>
                    <input type="text" id="new-image-caption">
                </div>
                <div id="new-personnel-section">
                    <label>PERSONNEL:</label>
                    <div id="new-personnel-list"></div>
                    <button type="button" id="add-personnel-btn" style="margin-top: 10px;">ADD PERSONNEL</button>
                </div>
                <div>
                    <button id="cancel-new-log">CANCEL</button>
                    <button id="save-new-log">SAVE</button>
                </div>
            </div>
            
            <h3>MISSION LOGS</h3>
            <div id="log-list">
                <!-- Log entries will be populated here -->
            </div>
        </div>
        
        <!-- Main content -->
        <div class="main-content">
            <div id="log-detail">
                <!-- Selected log will be displayed here -->
                <div id="welcome-message">
                    <h2>MISSION DATA CORE</h2>
                    <p>Select a mission log from the sidebar to view detailed information.</p>
                    <p id="security-warning" style="color: #ff0055;">WARNING: Some mission logs require security clearance.</p>
                </div>
            </div>
            
            <div id="edit-form" class="log-form" style="display: none;">
                <h3>EDIT LOG</h3>
                <label for="edit-title">TITLE:</label>
                <input type="text" id="edit-title">
                <label for="edit-date">DATE:</label>
                <input type="text" id="edit-date">
                <label for="edit-preview">PREVIEW:</label>
                <input type="text" id="edit-preview">
                <label for="edit-type">TYPE:</label>
                <div class="type-toggle">
                    <button type="button" id="edit-type-public" class="active">PUBLIC</button>
                    <button type="button" id="edit-type-private">CLASSIFIED</button>
                </div>
                <input type="hidden" id="edit-type" value="public">
                <label for="edit-content">CONTENT:</label>
                <textarea id="edit-content"></textarea>
                <div>
                    <input type="checkbox" id="edit-has-image" style="width: auto;">
                    <label for="edit-has-image">INCLUDE IMAGE</label>
                </div>
                <div id="edit-image-section" style="display: none;">
                    <label for="edit-image-url">IMAGE URL:</label>
                    <input type="text" id="edit-image-url">
                    <label for="edit-image-caption">CAPTION:</label>
                    <input type="text" id="edit-image-caption">
                </div>
                <div id="edit-personnel-section">
                    <label>PERSONNEL:</label>
                    <div id="edit-personnel-list"></div>
                    <button type="button" id="edit-add-personnel-btn" style="margin-top: 10px;">ADD PERSONNEL</button>
                </div>
                <div>
                    <button id="cancel-edit">CANCEL</button>
                    <button id="save-edit">SAVE</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CRT screen effect overlay -->
    <div class="crt-overlay">
        <div class="scanline"></div>
        <div class="flicker"></div>
        <div class="crt-glow"></div>
        <div class="scanlines"></div>
    </div>

    <script>
        // Initial log data
        const initialLogs = {
            public: [
                {
                    id: 1,
                    title: 'MISSION REPORT: Derelict Vessel "Chronos"',
                    date: '2385.03.15',
                    preview: 'Team encountered unknown biological entities in cargo hold B. Three casualties reported.',
                    type: 'public',
                    content: 'Upon arrival at the Chronos, Team Alpha established a perimeter around the main airlock. Initial scans revealed extremely low oxygen levels and signs of structural damage throughout the vessel. Captain Reyes ordered the team to proceed with caution and maintain constant communication.\n\nThe team moved through the central corridor towards the bridge, documenting evidence of a struggle. Three crew members were found deceased in cargo hold B, appearing to have suffered injuries consistent with [REDACTED].\n\nThe mission was aborted following contact with unknown biological entities. Full containment protocols were enacted. The Chronos has been marked for orbital destruction.',
                    hasImage: true,
                    imageUrl: 'https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=1000',
                    imageCaption: 'Chronos Vessel Exterior Scan',
                    personnel: [
                        {
                            name: 'Capt. Reyes',
                            imageUrl: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?q=80&w=150',
                            status: 'LIVING',
                            details: 'Mission commander. 15 years experience with deep space salvage operations.'
                        },
                        {
                            name: 'Dr. Chen',
                            imageUrl: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?q=80&w=150',
                            status: 'LIVING',
                            details: 'Xenobiologist. Specialized in hazardous organism containment.'
                        },
                        {
                            name: 'Tech Specialist Torres',
                            imageUrl: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=150',
                            status: 'DECEASED',
                            details: 'Found in cargo hold B. Cause of death: severe lacerations and blood loss.'
                        }
                    ]
                },
                {
                    id: 2,
                    title: 'INCIDENT REPORT: Colony Outpost "New Horizon"',
                    date: '2385.04.02',
                    preview: 'Communication blackout investigated. Colony found abandoned.',
                    type: 'public',
                    content: 'Following a 72-hour communication blackout, Team Bravo was dispatched to investigate New Horizon colony. The outpost was found abandoned with no signs of violence or forced evacuation.\n\nPower systems were operational. Food supplies untouched. Personal items left behind. The colony AI system "HERA" was unresponsive.\n\nData logs showed no unusual activity prior to the blackout. Search teams discovered unusual markings on the walls of the colony\'s lower levels. Samples have been collected for analysis.\n\nColony has been quarantined until further notice.',
                    hasImage: false,
                    personnel: []
                },
                {
                    id: 5,
                    title: 'EQUIPMENT REQUISITION: Deep Space Exploration',
                    date: '2385.05.10',
                    preview: 'Standard loadout plus specialized containment equipment approved.',
                    type: 'public',
                    content: 'The following equipment has been approved for deep space exploration mission DS-279:\n\n- Standard EVA suits (x6)\n- Extended life support modules (x12)\n- Portable atmosphere analyzer (x2)\n- Multi-spectrum scanners (x3)\n- Emergency medical kits (x4)\n- Portable containment units, Level 3 (x2)\n- Specimen collection kits (x10)\n- Emergency beacon system\n- Short-range shuttle craft\n\nAll equipment must be checked and certified by Security Officer Jensen before departure. Any unauthorized equipment will be confiscated and may result in mission delay.',
                    hasImage: false,
                    personnel: []
                }
            ],
            private: [
                {
                    id: 3,
                    title: 'CLASSIFIED: Autopsy Results - Chronos Incident',
                    date: '2385.03.16',
                    preview: 'Bio-weapon hypothesis confirmed. Genetic material does not match known database.',
                    type: 'private',
                    content: 'Autopsies performed on the three deceased crew members recovered from the Chronos revealed evidence of rapid cellular degradation. The biological agent appears to target the central nervous system, causing hallucinations before complete neural shutdown.\n\nGenetic sequencing of the agent shows no match to any known pathogen in the Davos Heavy Industries bioweapon database. Dr. Nakamura has expressed concern that this may be evidence of unauthorized experimentation or, more concerning, first contact with a non-terrestrial biological entity.\n\nRecommend immediate CLASS 4 containment protocols for all recovered specimens.',
                    hasImage: true,
                    imageUrl: 'https://images.unsplash.com/photo-1507413245164-6160d8298b31?q=80&w=1000',
                    imageCaption: 'Microscopic Analysis of Unknown Pathogen',
                    personnel: [
                        {
                            name: 'Dr. Nakamura',
                            imageUrl: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?q=80&w=150',
                            status: 'LIVING',
                            details: 'Lead Pathologist. Specialized in xenobiology and novel pathogen analysis.'
                        },
                        {
                            name: 'Tech Specialist Torres',
                            imageUrl: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=150',
                            status: 'DECEASED',
                            details: 'Autopsy confirmed rapid systemic cellular degradation. Evidence of hallucinatory episode prior to death.'
                        }
                    ]
                },
                {
                    id: 4,
                    title: 'EXECUTIVE BRIEF: New Horizon Situation',
                    date: '2385.04.03',
                    preview: 'Evidence suggests mass psychosis event. Possible memetic contamination.',
                    type: 'private',
                    content: 'Analysis of the markings found at New Horizon colony indicates a possible memetic contamination event. The symbols appear to follow mathematical patterns associated with previous incidents at research stations Epsilon and Gamma-7.\n\nSecurity footage recovered from HERA\'s backup systems shows colonists exhibiting increasing paranoia and ritualistic behavior in the 48 hours preceding the blackout. The colony\'s logs indicate all 47 colonists left the outpost on foot, heading northwest into the planet\'s unexplored mountain range. Satellite imagery has not been able to locate them.\n\nThe markings have been classified as BLACKSTAR level threat. All personnel involved in the investigation have been scheduled for psychological evaluation.',
                    hasImage: true,
                    imageUrl: 'https://images.unsplash.com/photo-1535139262971-c51845709a48?q=80&w=1000',
                    imageCaption: 'Symbol Pattern Analysis',
                    personnel: []
                },
                {
                    id: 6,
                    title: 'TRANSMISSION INTERCEPT: Unknown Origin',
                    date: '2385.05.12',
                    preview: 'Signal detected from sector 7. Linguistic analysis inconclusive.',
                    type: 'private',
                    content: 'At 0347 hours, deep space monitoring station Tango-9 detected an encrypted transmission originating from the unexplored region of sector 7. Signal pattern does not match any known human communication protocols.\n\nPreliminary linguistic analysis suggests an organized structure indicating intelligent origin, but translation efforts have been unsuccessful. The transmission lasted 73 seconds and has not repeated.\n\nOf particular concern is that the signal appears to have been directed specifically at Davos Heavy Industries research vessel "Horizon Seeker," which was conducting routine exploration approximately 4.3 light years from the signal origin.\n\nRecommend immediate recall of all vessels in the vicinity and establishment of a quarantine zone around sector 7 pending further investigation.',
                    hasImage: false,
                    personnel: []
                }
            ]
        };

        // Pattern access codes for each user level
        const patternCodes = {
            'admin': [0, 4, 8],        // Diagonal from top-left to bottom-right
            'gamemaster': [2, 4, 6],   // Diagonal from top-right to bottom-left
            'player': [1, 4, 7]        // Vertical middle line
        };

        // Application state
        let state = {
            authenticated: false,
            username: '',
            visibleLogs: [],
            selectedLog: null,
            editMode: false,
            logs: JSON.parse(localStorage.getItem('davosLogs')) || initialLogs,
            nextId: 7, // Updated to be one more than the highest ID in the initialLogs
            currentPattern: [],
            currentAccessLevel: 'admin'
        };

        // DOM Elements
        const elements = {
            loginForm: document.getElementById('login-form'),
            patternFeedback: document.getElementById('pattern-feedback'),
            adminTools: document.getElementById('admin-tools'),
            newLogForm: document.getElementById('new-log-form'),
            newImageSection: document.getElementById('new-image-section'),
            editImageSection: document.getElementById('edit-image-section'),
            newPersonnelList: document.getElementById('new-personnel-list'),
            editPersonnelList: document.getElementById('edit-personnel-list'),
            securityWarning: document.getElementById('security-warning'),
            logList: document.getElementById('log-list'),
            logDetail: document.getElementById('log-detail'),
            welcomeMessage: document.getElementById('welcome-message'),
            editForm: document.getElementById('edit-form'),
            importFile: document.getElementById('import-file'),
            crtOverlay: document.querySelector('.crt-overlay'),
            patternNodes: document.querySelectorAll('.pattern-node')
        };

        // Function to create a personnel form
        function createPersonnelForm(containerId, index, data = {}) {
            const container = document.getElementById(containerId);
            const formDiv = document.createElement('div');
            formDiv.className = 'personnel-form';
            formDiv.style.border = '1px solid #004400';
            formDiv.style.padding = '10px';
            formDiv.style.marginBottom = '10px';
            
            formDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <label>PERSONNEL #${index + 1}</label>
                    <button type="button" class="remove-personnel" data-index="${index}">REMOVE</button>
                </div>
                <div style="margin-bottom: 8px;">
                    <label>NAME:</label>
                    <input type="text" class="personnel-name-input" value="${data.name || ''}">
                </div>
                <div style="margin-bottom: 8px;">
                    <label>IMAGE URL:</label>
                    <input type="url" class="personnel-image-input" value="${data.imageUrl || ''}">
                </div>
                <div style="margin-bottom: 8px;">
                    <label>STATUS:</label>
                    <select class="personnel-status-input">
                        ${['LIVING', 'DECEASED', 'FUBAR', 'UNKNOWN', 'MISSING'].map(status => 
                            `<option value="${status}" ${data.status === status ? 'selected' : ''}>${status}</option>`
                        ).join('')}
                    </select>
                </div>
                <div>
                    <label>DETAILS:</label>
                    <textarea class="personnel-details-input" style="height: 60px;">${data.details || ''}</textarea>
                </div>
            `;
            
            container.appendChild(formDiv);
            
            // Add event listener to remove button
            formDiv.querySelector('.remove-personnel').addEventListener('click', function() {
                container.removeChild(formDiv);
            });
        }

        // Function to collect personnel data from form
        function collectPersonnelData(containerId) {
            const container = document.getElementById(containerId);
            const personnelForms = container.querySelectorAll('.personnel-form');
            const personnel = [];
            
            personnelForms.forEach(form => {
                personnel.push({
                    name: form.querySelector('.personnel-name-input').value,
                    imageUrl: form.querySelector('.personnel-image-input').value,
                    status: form.querySelector('.personnel-status-input').value,
                    details: form.querySelector('.personnel-details-input').value
                });
            });
            
            return personnel;
        }

        // Toggle Type Functions
        function toggleNewType() {
            document.getElementById('new-type-public').classList.toggle('active');
            document.getElementById('new-type-private').classList.toggle('active');
            
            if (document.getElementById('new-type-public').classList.contains('active')) {
                document.getElementById('new-type').value = 'public';
            } else {
                document.getElementById('new-type').value = 'private';
            }
        }
        
        function toggleEditType() {
            document.getElementById('edit-type-public').classList.toggle('active');
            document.getElementById('edit-type-private').classList.toggle('active');
            
            if (document.getElementById('edit-type-public').classList.contains('active')) {
                document.getElementById('edit-type').value = 'public';
            } else {
                document.getElementById('edit-type').value = 'private';
            }
        }

        // Pattern lock functions
        function selectPatternNode(node) {
            const index = parseInt(node.dataset.index);
            if (!state.currentPattern.includes(index)) {
                state.currentPattern.push(index);
                node.classList.add('selected');
                updatePatternNodes();
            }
        }
        
        function clearPattern() {
            state.currentPattern = [];
            updatePatternNodes();
            elements.patternFeedback.textContent = '';
            elements.patternFeedback.classList.remove('pulse');
        }
        
        function updatePatternNodes() {
            elements.patternNodes.forEach(node => {
                const index = parseInt(node.dataset.index);
                if (state.currentPattern.includes(index)) {
                    node.classList.add('selected');
                } else {
                    node.classList.remove('selected');
                }
            });
        }
        
        function verifyPattern() {
            const correctPattern = patternCodes[state.currentAccessLevel];
            
            // Check if pattern matches
            if (state.currentPattern.length === correctPattern.length &&
                state.currentPattern.every((val, idx) => val === correctPattern[idx])) {
                
                // Set authenticated state based on access level
                state.authenticated = true;
                state.username = state.currentAccessLevel;
                
                // Save session
                localStorage.setItem('davosSession', JSON.stringify({
                    username: state.username,
                    timestamp: new Date().getTime()
                }));
                
                // Update UI
                elements.patternFeedback.textContent = 'ACCESS GRANTED';
                elements.patternFeedback.style.color = '#00ff41';
                elements.patternFeedback.classList.add('pulse');
                
                // Delay to show success message before updating UI
                setTimeout(() => {
                    clearPattern();
                    updateUI();
                }, 1000);
            } else {
                // Failed login
                elements.patternFeedback.textContent = 'ACCESS DENIED - INVALID PATTERN';
                elements.patternFeedback.style.color = '#ff0055';
                elements.patternFeedback.classList.add('pulse');
                
                // Shake pattern nodes for error feedback
                elements.patternNodes.forEach(node => {
                    if (node.classList.contains('selected')) {
                        node.style.animation = 'none';
                        setTimeout(() => {
                            node.style.animation = 'shake 0.5s';
                        }, 10);
                    }
                });
                
                // Clear pattern after delay
                setTimeout(clearPattern, 1500);
            }
        }
        
        function setAccessLevel(level) {
            state.currentAccessLevel = level;
            
            // Update access level buttons
            document.getElementById('access-admin').classList.remove('active');
            document.getElementById('access-gamemaster').classList.remove('active');
            document.getElementById('access-player').classList.remove('active');
            document.getElementById(`access-${level}`).classList.add('active');
            
            // Clear pattern
            clearPattern();
        }

        // Add event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Login and navigation
            document.getElementById('clear-pattern').addEventListener('click', clearPattern);
            document.getElementById('submit-pattern').addEventListener('click', verifyPattern);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('new-log-btn').addEventListener('click', showNewLogForm);
            document.getElementById('cancel-new-log').addEventListener('click', hideNewLogForm);
            document.getElementById('save-new-log').addEventListener('click', saveNewLog);
            document.getElementById('cancel-edit').addEventListener('click', cancelEdit);
            document.getElementById('save-edit').addEventListener('click', saveEdit);
            document.getElementById('export-btn').addEventListener('click', exportLogs);
            document.getElementById('import-btn').addEventListener('click', () => elements.importFile.click());
            document.getElementById('import-file').addEventListener('change', importLogs);
            document.getElementById('new-has-image').addEventListener('change', toggleNewImageSection);
            document.getElementById('edit-has-image').addEventListener('change', toggleEditImageSection);
            document.getElementById('add-personnel-btn').addEventListener('click', function() {
                const container = document.getElementById('new-personnel-list');
                const index = container.querySelectorAll('.personnel-form').length;
                createPersonnelForm('new-personnel-list', index);
            });
            document.getElementById('edit-add-personnel-btn').addEventListener('click', function() {
                const container = document.getElementById('edit-personnel-list');
                const index = container.querySelectorAll('.personnel-form').length;
                createPersonnelForm('edit-personnel-list', index);
            });
            document.getElementById('toggle-crt-btn').addEventListener('click', toggleCrtEffect);
            
            // Pattern nodes
            elements.patternNodes.forEach(node => {
                node.addEventListener('click', () => selectPatternNode(node));
            });
            
            // Access level buttons
            document.getElementById('access-admin').addEventListener('click', () => setAccessLevel('admin'));
            document.getElementById('access-gamemaster').addEventListener('click', () => setAccessLevel('gamemaster'));
            document.getElementById('access-player').addEventListener('click', () => setAccessLevel('player'));
            
            // Type toggle buttons
            document.getElementById('new-type-public').addEventListener('click', function() {
                if (!this.classList.contains('active')) {
                    toggleNewType();
                }
            });
            document.getElementById('new-type-private').addEventListener('click', function() {
                if (!this.classList.contains('active')) {
                    toggleNewType();
                }
            });
            document.getElementById('edit-type-public').addEventListener('click', function() {
                if (!this.classList.contains('active')) {
                    toggleEditType();
                }
            });
            document.getElementById('edit-type-private').addEventListener('click', function() {
                if (!this.classList.contains('active')) {
                    toggleEditType();
                }
            });

            // Check saved CRT effect preference
            const savedCrtPreference = localStorage.getItem('crtEffect');
            if (savedCrtPreference === 'disabled') {
                elements.crtOverlay.style.display = 'none';
            }
            
            // Add shake animation style
            const style = document.createElement('style');
            style.textContent = `
                @keyframes shake {
                    0%, 100% { transform: translateX(0); }
                    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                    20%, 40%, 60%, 80% { transform: translateX(5px); }
                }
            `;
            document.head.appendChild(style);
            
            // Check for existing session
            checkSession();
            updateUI();
        });

        // Toggle CRT effect
        function toggleCrtEffect() {
            if (elements.crtOverlay.style.display === 'none') {
                elements.crtOverlay.style.display = 'block';
                localStorage.setItem('crtEffect', 'enabled');
            } else {
                elements.crtOverlay.style.display = 'none';
                localStorage.setItem('crtEffect', 'disabled');
            }
        }

        // Handle logout
        function handleLogout() {
            state.authenticated = false;
            state.username = '';
            state.selectedLog = null;
            state.editMode = false;
            
            localStorage.removeItem('davosSession');
            updateUI();
        }

        // Check for existing session
        function checkSession() {
            const savedSession = localStorage.getItem('davosSession');
            if (savedSession) {
                try {
                    const session = JSON.parse(savedSession);
                    if (session.username && ['admin', 'gamemaster', 'player'].includes(session.username)) {
                        state.authenticated = true;
                        state.username = session.username;
                    }
                } catch (e) {
                    localStorage.removeItem('davosSession');
                }
            }
        }

        // Update UI based on state
        function updateUI() {
            // Update visible logs - ensure same visibility on all devices
            if (state.authenticated) {
                // When authenticated, show all logs
                state.visibleLogs = [...state.logs.public];
                
                // Add private logs if user has appropriate access
                if (state.username === 'admin' || state.username === 'gamemaster') {
                    state.visibleLogs = [...state.visibleLogs, ...state.logs.private];
                }
                
                elements.loginForm.style.display = 'none';
                elements.adminTools.style.display = 'block';
                elements.securityWarning.style.display = 'none';
            } else {
                // When not authenticated, only show public logs
                state.visibleLogs = [...state.logs.public];
                elements.loginForm.style.display = 'block';
                elements.adminTools.style.display = 'none';
                elements.securityWarning.style.display = 'block';
            }
            
            // Render logs
            renderLogs();
            
            // Display appropriate content
            if (state.selectedLog && !state.editMode) {
                renderLogDetail(state.selectedLog);
                elements.welcomeMessage.style.display = 'none';
                elements.logDetail.style.display = 'block';
                elements.editForm.style.display = 'none';
            } else if (state.editMode && state.selectedLog) {
                populateEditForm(state.selectedLog);
                elements.welcomeMessage.style.display = 'none';
                elements.logDetail.style.display = 'none';
                elements.editForm.style.display = 'block';
            } else {
                elements.welcomeMessage.style.display = 'block';
                elements.logDetail.style.display = 'none';
                elements.editForm.style.display = 'none';
            }
        }

        // Render log list
        function renderLogs() {
            // Sort logs by date (newest first)
            const sortedLogs = state.visibleLogs.sort((a, b) => {
                return b.date.localeCompare(a.date);
            });
            
            elements.logList.innerHTML = '';
            
            sortedLogs.forEach(log => {
                const logElement = document.createElement('div');
                logElement.className = `log-entry ${state.selectedLog && state.selectedLog.id === log.id ? 'selected' : ''}`;
                logElement.dataset.id = log.id;
                
                const typeClass = log.type === 'public' ? 'public-log' : 'private-log';
                const typeText = log.type === 'public' ? 'PUBLIC' : 'CLASSIFIED';
                
                logElement.innerHTML = `
                    <div class="log-meta">
                        <span>${log.date}</span>
                        <span class="${typeClass}">${typeText}</span>
                    </div>
                    <div class="log-title">${log.title}</div>
                    <div class="log-preview">${log.preview}</div>
                `;
                
                logElement.addEventListener('click', () => {
                    state.selectedLog = log;
                    state.editMode = false;
                    updateUI();
                });
                
                elements.logList.appendChild(logElement);
            });
        }
